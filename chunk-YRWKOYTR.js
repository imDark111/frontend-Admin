import{a as le}from"./chunk-SPIEZRP7.js";import{a as ee}from"./chunk-RX47UBEE.js";import{Aa as Q,B as f,C as h,D as x,Eb as se,I as A,K as E,La as J,Ma as K,Na as X,Ra as Y,Sa as Z,Xa as $,Z as k,Za as te,aa as V,da as O,ea as I,gb as ie,h as d,ha as D,i as u,j as M,jb as ne,k as l,l as F,la as W,m as y,n as P,na as j,o as m,oa as z,p as n,pa as U,q as o,qa as N,r as p,ra as L,s as w,sa as B,sb as oe,t as _,u as r,ua as q,v as S,w as s,wb as ae,x as v,xa as R,y as T,ya as H,za as G,zb as re}from"./chunk-B4HSYOOP.js";import"./chunk-MWWENCHY.js";import"./chunk-7KGURMOZ.js";import"./chunk-JV5DO3IJ.js";import"./chunk-L3SNWROS.js";import"./chunk-EYYNAE2V.js";import"./chunk-JVTPOORY.js";import"./chunk-CLDSZD2A.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-DVVH2KKN.js";import"./chunk-NV3QH4JK.js";import"./chunk-G7SWQJ6W.js";import"./chunk-OZYWYLNK.js";import"./chunk-42C7ZIID.js";import"./chunk-JHI3MBHO.js";function ce(c,g){if(c&1){let t=w();n(0,"ion-item")(1,"ion-label",19),s(2,"Tel\xE9fono"),o(),n(3,"ion-input",30),x("ngModelChange",function(e){d(t);let a=r(2);return h(a.usuario.telefono,e)||(a.usuario.telefono=e),u(e)}),o()()}if(c&2){let t=r(2);l(3),f("ngModel",t.usuario.telefono),m("readonly",!t.editando)}}function de(c,g){if(c&1){let t=w();n(0,"ion-item")(1,"ion-label",19),s(2,"Direcci\xF3n"),o(),n(3,"ion-input",31),x("ngModelChange",function(e){d(t);let a=r(2);return h(a.usuario.direccion,e)||(a.usuario.direccion=e),u(e)}),o()()}if(c&2){let t=r(2);l(3),f("ngModel",t.usuario.direccion),m("readonly",!t.editando)}}function ue(c,g){if(c&1){let t=w();n(0,"ion-button",32),_("click",function(){d(t);let e=r(2);return u(e.guardarCambios())}),s(1," Guardar Cambios "),o()}}function me(c,g){if(c&1){let t=w();n(0,"div",33)(1,"ion-item")(2,"ion-label",19),s(3,"Contrase\xF1a Actual"),o(),n(4,"ion-input",34),x("ngModelChange",function(e){d(t);let a=r(2);return h(a.passwordData.passwordActual,e)||(a.passwordData.passwordActual=e),u(e)}),o()(),n(5,"ion-item")(6,"ion-label",19),s(7,"Nueva Contrase\xF1a"),o(),n(8,"ion-input",35),x("ngModelChange",function(e){d(t);let a=r(2);return h(a.passwordData.passwordNueva,e)||(a.passwordData.passwordNueva=e),u(e)}),o()(),n(9,"ion-item")(10,"ion-label",19),s(11,"Confirmar Contrase\xF1a"),o(),n(12,"ion-input",36),x("ngModelChange",function(e){d(t);let a=r(2);return h(a.passwordData.confirmarPassword,e)||(a.passwordData.confirmarPassword=e),u(e)}),o()(),n(13,"ion-button",32),_("click",function(){d(t);let e=r(2);return u(e.guardarPassword())}),s(14," Cambiar Contrase\xF1a "),o()()}if(c&2){let t=r(2);l(4),f("ngModel",t.passwordData.passwordActual),l(4),f("ngModel",t.passwordData.passwordNueva),l(4),f("ngModel",t.passwordData.confirmarPassword)}}function _e(c,g){if(c&1){let t=w();n(0,"div",8)(1,"ion-card",9)(2,"ion-card-content")(3,"div",10)(4,"ion-avatar",11),p(5,"img",12),o(),n(6,"ion-button",13),_("click",function(){d(t);let e=S(8);return u(e.click())}),n(7,"input",14,0),_("change",function(e){d(t);let a=r();return u(a.cambiarFoto(e))}),o(),p(9,"ion-icon",15),o()(),n(10,"h2"),s(11),o(),n(12,"p"),s(13),o()()(),n(14,"ion-card")(15,"ion-card-header")(16,"div",16)(17,"ion-card-title"),s(18,"Informaci\xF3n Personal"),o(),n(19,"ion-button",17),_("click",function(){d(t);let e=r();return u(e.editando=!e.editando)}),s(20),o()()(),n(21,"ion-card-content")(22,"ion-list")(23,"ion-item"),p(24,"ion-icon",18),n(25,"ion-label",19),s(26,"Nombre de Usuario"),o(),n(27,"ion-input",20),x("ngModelChange",function(e){d(t);let a=r();return h(a.usuario.nombreUsuario,e)||(a.usuario.nombreUsuario=e),u(e)}),o()(),n(28,"ion-item"),p(29,"ion-icon",21),n(30,"ion-label",19),s(31,"Email"),o(),n(32,"ion-input",22),x("ngModelChange",function(e){d(t);let a=r();return h(a.usuario.email,e)||(a.usuario.email=e),u(e)}),o()(),P(33,ce,4,2,"ion-item",23)(34,de,4,2,"ion-item",23),o(),P(35,ue,2,0,"ion-button",24),o()(),n(36,"ion-card")(37,"ion-card-header")(38,"ion-card-title"),s(39,"Seguridad"),o()(),n(40,"ion-card-content")(41,"ion-list")(42,"ion-item"),p(43,"ion-icon",25),n(44,"ion-label")(45,"h3"),s(46,"Autenticaci\xF3n de Dos Factores"),o(),n(47,"p"),s(48),o()(),n(49,"ion-toggle",26),x("ngModelChange",function(e){d(t);let a=r();return h(a.usuario.twoFactorEnabled,e)||(a.usuario.twoFactorEnabled=e),u(e)}),_("ionChange",function(e){d(t);let a=r();return u(a.toggle2FA(e))}),o()(),n(50,"ion-item",27),_("click",function(){d(t);let e=r();return u(e.cambiarPassword=!e.cambiarPassword)}),p(51,"ion-icon",28),n(52,"ion-label")(53,"h3"),s(54,"Cambiar Contrase\xF1a"),o()()()(),P(55,me,15,3,"div",29),o()()()}if(c&2){let t=r();l(5),m("src",t.getUrlFoto(),M)("alt",t.usuario.nombreUsuario),l(6),v(t.usuario.nombreUsuario),l(2),v(t.usuario.email),l(7),T(" ",t.editando?"Cancelar":"Editar"," "),l(7),f("ngModel",t.usuario.nombreUsuario),m("readonly",!t.editando),l(5),f("ngModel",t.usuario.email),m("readonly",!t.editando),l(),m("ngIf",t.usuario.telefono),l(),m("ngIf",t.usuario.direccion),l(),m("ngIf",t.editando),l(13),v(t.usuario.twoFactorEnabled?"Activado":"Desactivado"),l(),f("ngModel",t.usuario.twoFactorEnabled),l(6),m("ngIf",t.cambiarPassword)}}function ge(c,g){if(c&1){let t=w();n(0,"div",37),_("click",function(){d(t);let e=r();return u(e.cancelar2FA())}),o()}}function pe(c,g){if(c&1){let t=w();n(0,"ion-card",38)(1,"ion-card-header")(2,"div",39)(3,"ion-card-title"),s(4,"Configurar 2FA"),o(),n(5,"ion-button",40),_("click",function(){d(t);let e=r();return u(e.cancelar2FA())}),p(6,"ion-icon",41),o()()(),n(7,"ion-card-content")(8,"div",42)(9,"p"),s(10,"Escanea con Google Authenticator:"),o(),p(11,"img",43),n(12,"p",44),s(13,"C\xF3digo manual:"),o(),n(14,"p",45),s(15),o()(),n(16,"ion-item")(17,"ion-label",19),s(18,"C\xF3digo de Verificaci\xF3n"),o(),n(19,"ion-input",46),x("ngModelChange",function(e){d(t);let a=r();return h(a.codigo2FA,e)||(a.codigo2FA=e),u(e)}),o()(),n(20,"div",47)(21,"ion-button",48),_("click",function(){d(t);let e=r();return u(e.confirmar2FA())}),s(22," Confirmar "),o(),n(23,"ion-button",49),_("click",function(){d(t);let e=r();return u(e.cancelar2FA())}),s(24," Cancelar "),o()()()()}if(c&2){let t=r();l(11),m("src",t.qrCode2FA,M),l(4),v(t.secret2FA),l(4),f("ngModel",t.codigo2FA)}}function fe(c,g){if(c&1){let t=w();n(0,"div",37),_("click",function(){d(t);let e=r();return u(e.cancelarDesactivar2FA())}),o()}}function he(c,g){if(c&1){let t=w();n(0,"ion-card",50)(1,"ion-card-header")(2,"div",39)(3,"ion-card-title"),s(4,"Desactivar 2FA"),o(),n(5,"ion-button",40),_("click",function(){d(t);let e=r();return u(e.cancelarDesactivar2FA())}),p(6,"ion-icon",41),o()()(),n(7,"ion-card-content")(8,"p"),s(9,"Para desactivar la autenticaci\xF3n de dos factores, ingrese su contrase\xF1a:"),o(),n(10,"ion-item")(11,"ion-label",19),s(12,"Contrase\xF1a"),o(),n(13,"ion-input",51),x("ngModelChange",function(e){d(t);let a=r();return h(a.passwordDesactivar2FA,e)||(a.passwordDesactivar2FA=e),u(e)}),o()(),n(14,"div",47)(15,"ion-button",52),_("click",function(){d(t);let e=r();return u(e.desactivar2FA())}),s(16," Desactivar 2FA "),o(),n(17,"ion-button",49),_("click",function(){d(t);let e=r();return u(e.cancelarDesactivar2FA())}),s(18," Cancelar "),o()()()()}if(c&2){let t=r();l(13),f("ngModel",t.passwordDesactivar2FA)}}var Te=(()=>{let g=class g{constructor(i,e){this.authService=i,this.usuarioService=e,this.usuario=null,this.editando=!1,this.cambiarPassword=!1,this.passwordData={passwordActual:"",passwordNueva:"",confirmarPassword:""},this.mostrarToast=!1,this.mensajeToast="",this.mostrar2FAModal=!1,this.qrCode2FA="",this.secret2FA="",this.codigo2FA="",this.passwordDesactivar2FA="",this.desactivando2FA=!1,te({personOutline:re,mailOutline:ae,cameraOutline:ie,keyOutline:oe,shieldCheckmarkOutline:se,close:ne})}ngOnInit(){this.authService.currentUser.subscribe(i=>{this.usuario=i})}cambiarFoto(i){let e=i.target.files[0];if(e){console.log("\u{1F4F8} Archivo seleccionado:",e.name,e.type,e.size);let a=new FormData;a.append("fotoPerfil",e),this.usuarioService.cambiarFoto(a).subscribe({next:C=>{if(console.log("\u2705 Respuesta del servidor:",C),C.success&&(this.mensajeToast="Foto actualizada exitosamente",this.mostrarToast=!0,this.usuario&&C.data&&C.data.fotoPerfil)){let b=C.data.fotoPerfil;console.log("\u{1F5BC}\uFE0F Nueva foto URL:",b),this.usuario.fotoPerfil=b+"?t="+new Date().getTime(),this.authService.actualizarFotoPerfil(b)}},error:C=>{console.error("\u274C Error al actualizar foto:",C),this.mensajeToast=C.error?.message||"Error al actualizar foto",this.mostrarToast=!0}})}}guardarCambios(){this.usuario&&this.usuarioService.actualizarUsuario(this.usuario.id,this.usuario).subscribe({next:i=>{i.success&&(this.mensajeToast="Perfil actualizado exitosamente",this.mostrarToast=!0,this.editando=!1)},error:i=>{this.mensajeToast="Error al actualizar perfil",this.mostrarToast=!0}})}guardarPassword(){if(this.passwordData.passwordNueva!==this.passwordData.confirmarPassword){this.mensajeToast="Las contrase\xF1as no coinciden",this.mostrarToast=!0;return}this.usuarioService.cambiarPassword({passwordActual:this.passwordData.passwordActual,passwordNueva:this.passwordData.passwordNueva}).subscribe({next:i=>{i.success&&(this.mensajeToast="Contrase\xF1a actualizada exitosamente",this.mostrarToast=!0,this.cambiarPassword=!1,this.passwordData={passwordActual:"",passwordNueva:"",confirmarPassword:""})},error:i=>{this.mensajeToast="Error al cambiar contrase\xF1a",this.mostrarToast=!0}})}toggle2FA(i){if(!this.usuario)return;let e=!i.detail.checked;e===!1&&i.detail.checked===!0?this.authService.enable2FA().subscribe({next:a=>{a.success&&a.data&&(this.qrCode2FA=a.data.qrCode,this.secret2FA=a.data.secret,this.mostrar2FAModal=!0)},error:a=>{this.mensajeToast="Error al generar c\xF3digo 2FA",this.mostrarToast=!0,this.usuario&&(this.usuario.twoFactorEnabled=!1)}}):e===!0&&i.detail.checked===!1&&(this.desactivando2FA=!0)}confirmar2FA(){if(!this.codigo2FA){this.mensajeToast="Por favor ingrese el c\xF3digo",this.mostrarToast=!0;return}this.authService.confirm2FA(this.codigo2FA).subscribe({next:i=>{i.success&&(this.mensajeToast="Autenticaci\xF3n de dos factores activada",this.mostrarToast=!0,this.mostrar2FAModal=!1,this.codigo2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!0))},error:i=>{this.mensajeToast="C\xF3digo inv\xE1lido",this.mostrarToast=!0}})}cancelar2FA(){this.mostrar2FAModal=!1,this.codigo2FA="",this.qrCode2FA="",this.secret2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!1)}desactivar2FA(){if(!this.passwordDesactivar2FA){this.mensajeToast="Por favor ingrese su contrase\xF1a",this.mostrarToast=!0;return}this.authService.disable2FA(this.passwordDesactivar2FA).subscribe({next:i=>{i.success&&(this.mensajeToast="Autenticaci\xF3n de dos factores desactivada",this.mostrarToast=!0,this.desactivando2FA=!1,this.passwordDesactivar2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!1))},error:i=>{this.mensajeToast=i.error?.message||"Error al desactivar 2FA",this.mostrarToast=!0,this.usuario&&(this.usuario.twoFactorEnabled=!0)}})}cancelarDesactivar2FA(){this.desactivando2FA=!1,this.passwordDesactivar2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!0)}getUrlFoto(){if(!this.usuario?.fotoPerfil)return`https://ui-avatars.com/api/?name=${encodeURIComponent(this.usuario?.nombreUsuario||"User")}&background=1b5e20&color=fff&size=200`;let i=this.usuario.fotoPerfil;return i.startsWith("http://")||i.startsWith("https://")?i:`http://192.168.0.11:3000${i.startsWith("/")?i:"/"+i}`}};g.\u0275fac=function(e){return new(e||g)(F(ee),F(le))},g.\u0275cmp=y({type:g,selectors:[["app-perfil"]],decls:13,vars:8,consts:[["fileInput",""],["slot","start"],["defaultHref","/dashboard"],["class","perfil-container",4,"ngIf"],["class","modal-overlay",3,"click",4,"ngIf"],["class","modal-2fa",4,"ngIf"],["class","modal-2fa modal-desactivar",4,"ngIf"],[3,"didDismiss","isOpen","message","duration"],[1,"perfil-container"],[1,"foto-card"],[1,"foto-container"],[1,"avatar-large"],[3,"src","alt"],["fill","clear",1,"cambiar-foto-btn",3,"click"],["type","file","accept","image/*","hidden","",3,"change"],["name","camera-outline"],[1,"card-header"],["fill","clear",3,"click"],["name","person-outline","slot","start"],["position","stacked"],["placeholder","Nombre de usuario",3,"ngModelChange","ngModel","readonly"],["name","mail-outline","slot","start"],["type","email","placeholder","Email",3,"ngModelChange","ngModel","readonly"],[4,"ngIf"],["expand","block","class","save-btn",3,"click",4,"ngIf"],["name","shield-checkmark-outline","slot","start"],[3,"ngModelChange","ionChange","ngModel"],["button","",3,"click"],["name","key-outline","slot","start"],["class","password-form",4,"ngIf"],["placeholder","Tel\xE9fono",3,"ngModelChange","ngModel","readonly"],["placeholder","Direcci\xF3n",3,"ngModelChange","ngModel","readonly"],["expand","block",1,"save-btn",3,"click"],[1,"password-form"],["type","password","placeholder","Contrase\xF1a actual",3,"ngModelChange","ngModel"],["type","password","placeholder","Nueva contrase\xF1a",3,"ngModelChange","ngModel"],["type","password","placeholder","Confirmar contrase\xF1a",3,"ngModelChange","ngModel"],[1,"modal-overlay",3,"click"],[1,"modal-2fa"],[1,"modal-header"],["fill","clear",1,"close-button",3,"click"],["name","close","slot","icon-only"],[1,"qr-container"],["alt","QR Code 2FA",1,"qr-code",3,"src"],[1,"secret-text"],[1,"secret-code"],["type","text","placeholder","Ingrese el c\xF3digo de 6 d\xEDgitos","maxlength","6",3,"ngModelChange","ngModel"],[1,"button-group"],["expand","block",3,"click"],["expand","block","fill","outline",3,"click"],[1,"modal-2fa","modal-desactivar"],["type","password","placeholder","Ingrese su contrase\xF1a",3,"ngModelChange","ngModel"],["expand","block","color","danger",3,"click"]],template:function(e,a){e&1&&(n(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),p(3,"ion-back-button",2),o(),n(4,"ion-title"),s(5,"Mi Perfil"),o()()(),n(6,"ion-content"),P(7,_e,56,15,"div",3)(8,ge,1,0,"div",4)(9,pe,25,3,"ion-card",5)(10,fe,1,0,"div",4)(11,he,19,1,"ion-card",6),n(12,"ion-toast",7),_("didDismiss",function(){return a.mostrarToast=!1}),o()()),e&2&&(l(7),m("ngIf",a.usuario),l(),m("ngIf",a.mostrar2FAModal),l(),m("ngIf",a.mostrar2FAModal),l(),m("ngIf",a.desactivando2FA),l(),m("ngIf",a.desactivando2FA),l(),m("isOpen",a.mostrarToast)("message",a.mensajeToast)("duration",3e3))},dependencies:[E,A,I,k,O,V,R,X,J,q,z,D,U,L,B,N,Q,H,G,Z,j,Y,W,$,K],styles:[".perfil-container[_ngcontent-%COMP%]{padding:16px;max-width:600px;margin:0 auto}.foto-card[_ngcontent-%COMP%]{text-align:center}.foto-card[_ngcontent-%COMP%]   .foto-container[_ngcontent-%COMP%]{position:relative;display:inline-block;margin-bottom:16px}.foto-card[_ngcontent-%COMP%]   .foto-container[_ngcontent-%COMP%]   .avatar-large[_ngcontent-%COMP%]{width:120px;height:120px}.foto-card[_ngcontent-%COMP%]   .foto-container[_ngcontent-%COMP%]   .cambiar-foto-btn[_ngcontent-%COMP%]{position:absolute;bottom:0;right:0;--border-radius: 50%;--padding-start: 8px;--padding-end: 8px}.foto-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:8px 0;font-weight:600}.foto-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--ion-color-medium);margin:4px 0}.card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.save-btn[_ngcontent-%COMP%]{margin-top:16px;--border-radius: 12px}.password-form[_ngcontent-%COMP%]{margin-top:16px;padding-top:16px;border-top:1px solid var(--ion-color-light)}ion-list[_ngcontent-%COMP%]{background:transparent}ion-item[_ngcontent-%COMP%]{--background: transparent}.modal-overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;z-index:999;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal-2fa[_ngcontent-%COMP%]{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:85%;max-width:420px;max-height:85vh;overflow-y:auto;z-index:1000;box-shadow:0 8px 32px #0000004d}.modal-2fa[_ngcontent-%COMP%]   .modal-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.modal-2fa[_ngcontent-%COMP%]   .modal-header[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{font-size:1.2rem}.modal-2fa[_ngcontent-%COMP%]   .modal-header[_ngcontent-%COMP%]   .close-button[_ngcontent-%COMP%]{--padding-start: 8px;--padding-end: 8px;margin:0}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]{text-align:center;padding:8px}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:8px 0;font-size:.9rem;color:var(--ion-color-medium)}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   .qr-code[_ngcontent-%COMP%]{width:180px;height:180px;margin:12px auto;border:2px solid var(--ion-color-light);border-radius:8px;padding:6px;background:#fff}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   .secret-text[_ngcontent-%COMP%]{font-weight:600;font-size:.85rem;margin-top:16px}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   .secret-code[_ngcontent-%COMP%]{font-family:monospace;font-size:11px;font-weight:600;color:var(--ion-color-primary);background:var(--ion-color-light);padding:8px;border-radius:6px;word-break:break-all;margin:8px 0}.modal-2fa[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px;margin-top:12px}.modal-desactivar[_ngcontent-%COMP%]{max-width:380px}.modal-desactivar[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.95rem;margin-bottom:16px;color:var(--ion-color-medium)}"]});let c=g;return c})();export{Te as PerfilPage};
