import{a as se}from"./chunk-55OPF5ZB.js";import{a as ee}from"./chunk-VLQAVE7D.js";import{Aa as Q,B as p,C as f,D as h,Db as re,I as E,K as T,La as J,Ma as K,Na as X,Ra as Y,Sa as Z,Xa as $,Z as k,Za as te,aa as V,da as I,ea as O,gb as ie,h as d,ha as D,i as u,j as F,k as l,l as M,la as W,m as y,n as P,na as j,o as m,oa as U,p as n,pa as N,q as a,qa as L,r as w,ra as z,rb as ne,s as C,sa as B,t as g,u as s,ua as q,v as S,vb as oe,w as r,x as b,xa as R,y as A,ya as H,yb as ae,za as G}from"./chunk-76QKIYJX.js";import"./chunk-MWWENCHY.js";import"./chunk-7KGURMOZ.js";import"./chunk-JV5DO3IJ.js";import"./chunk-L3SNWROS.js";import"./chunk-EYYNAE2V.js";import"./chunk-JVTPOORY.js";import"./chunk-CLDSZD2A.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-DVVH2KKN.js";import"./chunk-NV3QH4JK.js";import"./chunk-G7SWQJ6W.js";import"./chunk-OZYWYLNK.js";import"./chunk-42C7ZIID.js";import"./chunk-JHI3MBHO.js";function le(c,_){if(c&1){let t=C();n(0,"ion-item")(1,"ion-label",17),r(2,"Tel\xE9fono"),a(),n(3,"ion-input",28),h("ngModelChange",function(e){d(t);let o=s(2);return f(o.usuario.telefono,e)||(o.usuario.telefono=e),u(e)}),a()()}if(c&2){let t=s(2);l(3),p("ngModel",t.usuario.telefono),m("readonly",!t.editando)}}function ce(c,_){if(c&1){let t=C();n(0,"ion-item")(1,"ion-label",17),r(2,"Direcci\xF3n"),a(),n(3,"ion-input",29),h("ngModelChange",function(e){d(t);let o=s(2);return f(o.usuario.direccion,e)||(o.usuario.direccion=e),u(e)}),a()()}if(c&2){let t=s(2);l(3),p("ngModel",t.usuario.direccion),m("readonly",!t.editando)}}function de(c,_){if(c&1){let t=C();n(0,"ion-button",30),g("click",function(){d(t);let e=s(2);return u(e.guardarCambios())}),r(1," Guardar Cambios "),a()}}function ue(c,_){if(c&1){let t=C();n(0,"div",31)(1,"ion-item")(2,"ion-label",17),r(3,"Contrase\xF1a Actual"),a(),n(4,"ion-input",32),h("ngModelChange",function(e){d(t);let o=s(2);return f(o.passwordData.passwordActual,e)||(o.passwordData.passwordActual=e),u(e)}),a()(),n(5,"ion-item")(6,"ion-label",17),r(7,"Nueva Contrase\xF1a"),a(),n(8,"ion-input",33),h("ngModelChange",function(e){d(t);let o=s(2);return f(o.passwordData.passwordNueva,e)||(o.passwordData.passwordNueva=e),u(e)}),a()(),n(9,"ion-item")(10,"ion-label",17),r(11,"Confirmar Contrase\xF1a"),a(),n(12,"ion-input",34),h("ngModelChange",function(e){d(t);let o=s(2);return f(o.passwordData.confirmarPassword,e)||(o.passwordData.confirmarPassword=e),u(e)}),a()(),n(13,"ion-button",30),g("click",function(){d(t);let e=s(2);return u(e.guardarPassword())}),r(14," Cambiar Contrase\xF1a "),a()()}if(c&2){let t=s(2);l(4),p("ngModel",t.passwordData.passwordActual),l(4),p("ngModel",t.passwordData.passwordNueva),l(4),p("ngModel",t.passwordData.confirmarPassword)}}function me(c,_){if(c&1){let t=C();n(0,"div",6)(1,"ion-card",7)(2,"ion-card-content")(3,"div",8)(4,"ion-avatar",9),w(5,"img",10),a(),n(6,"ion-button",11),g("click",function(){d(t);let e=S(8);return u(e.click())}),n(7,"input",12,0),g("change",function(e){d(t);let o=s();return u(o.cambiarFoto(e))}),a(),w(9,"ion-icon",13),a()(),n(10,"h2"),r(11),a(),n(12,"p"),r(13),a()()(),n(14,"ion-card")(15,"ion-card-header")(16,"div",14)(17,"ion-card-title"),r(18,"Informaci\xF3n Personal"),a(),n(19,"ion-button",15),g("click",function(){d(t);let e=s();return u(e.editando=!e.editando)}),r(20),a()()(),n(21,"ion-card-content")(22,"ion-list")(23,"ion-item"),w(24,"ion-icon",16),n(25,"ion-label",17),r(26,"Nombre de Usuario"),a(),n(27,"ion-input",18),h("ngModelChange",function(e){d(t);let o=s();return f(o.usuario.nombreUsuario,e)||(o.usuario.nombreUsuario=e),u(e)}),a()(),n(28,"ion-item"),w(29,"ion-icon",19),n(30,"ion-label",17),r(31,"Email"),a(),n(32,"ion-input",20),h("ngModelChange",function(e){d(t);let o=s();return f(o.usuario.email,e)||(o.usuario.email=e),u(e)}),a()(),P(33,le,4,2,"ion-item",21)(34,ce,4,2,"ion-item",21),a(),P(35,de,2,0,"ion-button",22),a()(),n(36,"ion-card")(37,"ion-card-header")(38,"ion-card-title"),r(39,"Seguridad"),a()(),n(40,"ion-card-content")(41,"ion-list")(42,"ion-item"),w(43,"ion-icon",23),n(44,"ion-label")(45,"h3"),r(46,"Autenticaci\xF3n de Dos Factores"),a(),n(47,"p"),r(48),a()(),n(49,"ion-toggle",24),h("ngModelChange",function(e){d(t);let o=s();return f(o.usuario.twoFactorEnabled,e)||(o.usuario.twoFactorEnabled=e),u(e)}),g("ionChange",function(e){d(t);let o=s();return u(o.toggle2FA(e))}),a()(),n(50,"ion-item",25),g("click",function(){d(t);let e=s();return u(e.cambiarPassword=!e.cambiarPassword)}),w(51,"ion-icon",26),n(52,"ion-label")(53,"h3"),r(54,"Cambiar Contrase\xF1a"),a()()()(),P(55,ue,15,3,"div",27),a()()()}if(c&2){let t=s();l(5),m("src",t.getUrlFoto(),F)("alt",t.usuario.nombreUsuario),l(6),b(t.usuario.nombreUsuario),l(2),b(t.usuario.email),l(7),A(" ",t.editando?"Cancelar":"Editar"," "),l(7),p("ngModel",t.usuario.nombreUsuario),m("readonly",!t.editando),l(5),p("ngModel",t.usuario.email),m("readonly",!t.editando),l(),m("ngIf",t.usuario.telefono),l(),m("ngIf",t.usuario.direccion),l(),m("ngIf",t.editando),l(13),b(t.usuario.twoFactorEnabled?"Activado":"Desactivado"),l(),p("ngModel",t.usuario.twoFactorEnabled),l(6),m("ngIf",t.cambiarPassword)}}function _e(c,_){if(c&1){let t=C();n(0,"ion-card",35)(1,"ion-card-header")(2,"ion-card-title"),r(3,"Configurar Autenticaci\xF3n de Dos Factores"),a()(),n(4,"ion-card-content")(5,"div",36)(6,"p"),r(7,"Escanea este c\xF3digo QR con Google Authenticator o Authy:"),a(),w(8,"img",37),n(9,"p",38),r(10,"O ingresa manualmente este c\xF3digo:"),a(),n(11,"p",39),r(12),a()(),n(13,"ion-item")(14,"ion-label",17),r(15,"C\xF3digo de Verificaci\xF3n"),a(),n(16,"ion-input",40),h("ngModelChange",function(e){d(t);let o=s();return f(o.codigo2FA,e)||(o.codigo2FA=e),u(e)}),a()(),n(17,"div",41)(18,"ion-button",42),g("click",function(){d(t);let e=s();return u(e.confirmar2FA())}),r(19," Confirmar "),a(),n(20,"ion-button",43),g("click",function(){d(t);let e=s();return u(e.cancelar2FA())}),r(21," Cancelar "),a()()()()}if(c&2){let t=s();l(8),m("src",t.qrCode2FA,F),l(4),b(t.secret2FA),l(4),p("ngModel",t.codigo2FA)}}function ge(c,_){if(c&1){let t=C();n(0,"ion-card",35)(1,"ion-card-header")(2,"ion-card-title"),r(3,"Desactivar Autenticaci\xF3n de Dos Factores"),a()(),n(4,"ion-card-content")(5,"p"),r(6,"Para desactivar la autenticaci\xF3n de dos factores, ingrese su contrase\xF1a:"),a(),n(7,"ion-item")(8,"ion-label",17),r(9,"Contrase\xF1a"),a(),n(10,"ion-input",44),h("ngModelChange",function(e){d(t);let o=s();return f(o.passwordDesactivar2FA,e)||(o.passwordDesactivar2FA=e),u(e)}),a()(),n(11,"div",41)(12,"ion-button",45),g("click",function(){d(t);let e=s();return u(e.desactivar2FA())}),r(13," Desactivar 2FA "),a(),n(14,"ion-button",43),g("click",function(){d(t);let e=s();return u(e.cancelarDesactivar2FA())}),r(15," Cancelar "),a()()()()}if(c&2){let t=s();l(10),p("ngModel",t.passwordDesactivar2FA)}}var Me=(()=>{let _=class _{constructor(i,e){this.authService=i,this.usuarioService=e,this.usuario=null,this.editando=!1,this.cambiarPassword=!1,this.passwordData={passwordActual:"",passwordNueva:"",confirmarPassword:""},this.mostrarToast=!1,this.mensajeToast="",this.mostrar2FAModal=!1,this.qrCode2FA="",this.secret2FA="",this.codigo2FA="",this.passwordDesactivar2FA="",this.desactivando2FA=!1,te({personOutline:ae,mailOutline:oe,cameraOutline:ie,keyOutline:ne,shieldCheckmarkOutline:re})}ngOnInit(){this.authService.currentUser.subscribe(i=>{this.usuario=i})}cambiarFoto(i){let e=i.target.files[0];if(e){console.log("\u{1F4F8} Archivo seleccionado:",e.name,e.type,e.size);let o=new FormData;o.append("fotoPerfil",e),this.usuarioService.cambiarFoto(o).subscribe({next:x=>{if(console.log("\u2705 Respuesta del servidor:",x),x.success&&(this.mensajeToast="Foto actualizada exitosamente",this.mostrarToast=!0,this.usuario&&x.data&&x.data.fotoPerfil)){let v=x.data.fotoPerfil;console.log("\u{1F5BC}\uFE0F Nueva foto URL:",v),this.usuario.fotoPerfil=v+"?t="+new Date().getTime(),this.authService.actualizarFotoPerfil(v)}},error:x=>{console.error("\u274C Error al actualizar foto:",x),this.mensajeToast=x.error?.message||"Error al actualizar foto",this.mostrarToast=!0}})}}guardarCambios(){this.usuario&&this.usuarioService.actualizarUsuario(this.usuario.id,this.usuario).subscribe({next:i=>{i.success&&(this.mensajeToast="Perfil actualizado exitosamente",this.mostrarToast=!0,this.editando=!1)},error:i=>{this.mensajeToast="Error al actualizar perfil",this.mostrarToast=!0}})}guardarPassword(){if(this.passwordData.passwordNueva!==this.passwordData.confirmarPassword){this.mensajeToast="Las contrase\xF1as no coinciden",this.mostrarToast=!0;return}this.usuarioService.cambiarPassword({passwordActual:this.passwordData.passwordActual,passwordNueva:this.passwordData.passwordNueva}).subscribe({next:i=>{i.success&&(this.mensajeToast="Contrase\xF1a actualizada exitosamente",this.mostrarToast=!0,this.cambiarPassword=!1,this.passwordData={passwordActual:"",passwordNueva:"",confirmarPassword:""})},error:i=>{this.mensajeToast="Error al cambiar contrase\xF1a",this.mostrarToast=!0}})}toggle2FA(i){if(!this.usuario)return;let e=!i.detail.checked;e===!1&&i.detail.checked===!0?this.authService.enable2FA().subscribe({next:o=>{o.success&&o.data&&(this.qrCode2FA=o.data.qrCode,this.secret2FA=o.data.secret,this.mostrar2FAModal=!0)},error:o=>{this.mensajeToast="Error al generar c\xF3digo 2FA",this.mostrarToast=!0,this.usuario&&(this.usuario.twoFactorEnabled=!1)}}):e===!0&&i.detail.checked===!1&&(this.desactivando2FA=!0)}confirmar2FA(){if(!this.codigo2FA){this.mensajeToast="Por favor ingrese el c\xF3digo",this.mostrarToast=!0;return}this.authService.confirm2FA(this.codigo2FA).subscribe({next:i=>{i.success&&(this.mensajeToast="Autenticaci\xF3n de dos factores activada",this.mostrarToast=!0,this.mostrar2FAModal=!1,this.codigo2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!0))},error:i=>{this.mensajeToast="C\xF3digo inv\xE1lido",this.mostrarToast=!0}})}cancelar2FA(){this.mostrar2FAModal=!1,this.codigo2FA="",this.qrCode2FA="",this.secret2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!1)}desactivar2FA(){if(!this.passwordDesactivar2FA){this.mensajeToast="Por favor ingrese su contrase\xF1a",this.mostrarToast=!0;return}this.authService.disable2FA(this.passwordDesactivar2FA).subscribe({next:i=>{i.success&&(this.mensajeToast="Autenticaci\xF3n de dos factores desactivada",this.mostrarToast=!0,this.desactivando2FA=!1,this.passwordDesactivar2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!1))},error:i=>{this.mensajeToast=i.error?.message||"Error al desactivar 2FA",this.mostrarToast=!0,this.usuario&&(this.usuario.twoFactorEnabled=!0)}})}cancelarDesactivar2FA(){this.desactivando2FA=!1,this.passwordDesactivar2FA="",this.usuario&&(this.usuario.twoFactorEnabled=!0)}getUrlFoto(){if(!this.usuario?.fotoPerfil)return`https://ui-avatars.com/api/?name=${encodeURIComponent(this.usuario?.nombreUsuario||"User")}&background=1b5e20&color=fff&size=200`;let i=this.usuario.fotoPerfil;return i.startsWith("http://")||i.startsWith("https://")?i:`http://192.168.0.11:3000${i.startsWith("/")?i:"/"+i}`}};_.\u0275fac=function(e){return new(e||_)(M(ee),M(se))},_.\u0275cmp=y({type:_,selectors:[["app-perfil"]],decls:11,vars:6,consts:[["fileInput",""],["slot","start"],["defaultHref","/dashboard"],["class","perfil-container",4,"ngIf"],["class","modal-2fa",4,"ngIf"],[3,"didDismiss","isOpen","message","duration"],[1,"perfil-container"],[1,"foto-card"],[1,"foto-container"],[1,"avatar-large"],[3,"src","alt"],["fill","clear",1,"cambiar-foto-btn",3,"click"],["type","file","accept","image/*","hidden","",3,"change"],["name","camera-outline"],[1,"card-header"],["fill","clear",3,"click"],["name","person-outline","slot","start"],["position","stacked"],["placeholder","Nombre de usuario",3,"ngModelChange","ngModel","readonly"],["name","mail-outline","slot","start"],["type","email","placeholder","Email",3,"ngModelChange","ngModel","readonly"],[4,"ngIf"],["expand","block","class","save-btn",3,"click",4,"ngIf"],["name","shield-checkmark-outline","slot","start"],[3,"ngModelChange","ionChange","ngModel"],["button","",3,"click"],["name","key-outline","slot","start"],["class","password-form",4,"ngIf"],["placeholder","Tel\xE9fono",3,"ngModelChange","ngModel","readonly"],["placeholder","Direcci\xF3n",3,"ngModelChange","ngModel","readonly"],["expand","block",1,"save-btn",3,"click"],[1,"password-form"],["type","password","placeholder","Contrase\xF1a actual",3,"ngModelChange","ngModel"],["type","password","placeholder","Nueva contrase\xF1a",3,"ngModelChange","ngModel"],["type","password","placeholder","Confirmar contrase\xF1a",3,"ngModelChange","ngModel"],[1,"modal-2fa"],[1,"qr-container"],["alt","QR Code 2FA",1,"qr-code",3,"src"],[1,"secret-text"],[1,"secret-code"],["type","text","placeholder","Ingrese el c\xF3digo de 6 d\xEDgitos","maxlength","6",3,"ngModelChange","ngModel"],[1,"button-group"],["expand","block",3,"click"],["expand","block","fill","outline",3,"click"],["type","password","placeholder","Ingrese su contrase\xF1a",3,"ngModelChange","ngModel"],["expand","block","color","danger",3,"click"]],template:function(e,o){e&1&&(n(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),w(3,"ion-back-button",2),a(),n(4,"ion-title"),r(5,"Mi Perfil"),a()()(),n(6,"ion-content"),P(7,me,56,15,"div",3)(8,_e,22,3,"ion-card",4)(9,ge,16,1,"ion-card",4),n(10,"ion-toast",5),g("didDismiss",function(){return o.mostrarToast=!1}),a()()),e&2&&(l(7),m("ngIf",o.usuario),l(),m("ngIf",o.mostrar2FAModal),l(),m("ngIf",o.desactivando2FA),l(),m("isOpen",o.mostrarToast)("message",o.mensajeToast)("duration",3e3))},dependencies:[T,E,O,k,I,V,R,X,J,q,U,D,N,z,B,L,Q,H,G,Z,j,Y,W,$,K],styles:[".perfil-container[_ngcontent-%COMP%]{padding:16px;max-width:600px;margin:0 auto}.foto-card[_ngcontent-%COMP%]{text-align:center}.foto-card[_ngcontent-%COMP%]   .foto-container[_ngcontent-%COMP%]{position:relative;display:inline-block;margin-bottom:16px}.foto-card[_ngcontent-%COMP%]   .foto-container[_ngcontent-%COMP%]   .avatar-large[_ngcontent-%COMP%]{width:120px;height:120px}.foto-card[_ngcontent-%COMP%]   .foto-container[_ngcontent-%COMP%]   .cambiar-foto-btn[_ngcontent-%COMP%]{position:absolute;bottom:0;right:0;--border-radius: 50%;--padding-start: 8px;--padding-end: 8px}.foto-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:8px 0;font-weight:600}.foto-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--ion-color-medium);margin:4px 0}.card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.save-btn[_ngcontent-%COMP%]{margin-top:16px;--border-radius: 12px}.password-form[_ngcontent-%COMP%]{margin-top:16px;padding-top:16px;border-top:1px solid var(--ion-color-light)}ion-list[_ngcontent-%COMP%]{background:transparent}ion-item[_ngcontent-%COMP%]{--background: transparent}.modal-2fa[_ngcontent-%COMP%]{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;z-index:1000;box-shadow:0 8px 32px #0000004d}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]{text-align:center;padding:16px}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:12px 0;color:var(--ion-color-medium)}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   .qr-code[_ngcontent-%COMP%]{width:250px;height:250px;margin:16px auto;border:2px solid var(--ion-color-light);border-radius:8px;padding:8px;background:#fff}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   .secret-text[_ngcontent-%COMP%]{font-weight:600;margin-top:24px}.modal-2fa[_ngcontent-%COMP%]   .qr-container[_ngcontent-%COMP%]   .secret-code[_ngcontent-%COMP%]{font-family:monospace;font-size:18px;font-weight:600;color:var(--ion-color-primary);background:var(--ion-color-light);padding:12px;border-radius:8px;word-break:break-all}.modal-2fa[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:12px;margin-top:16px}"]});let c=_;return c})();export{Me as PerfilPage};
